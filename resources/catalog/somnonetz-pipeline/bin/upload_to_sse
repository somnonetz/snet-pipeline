#!/usr/bin/env node
'use strict'

const { uploadData } = require('asclepios-sse-client');
const { ArgumentParser } = require('argparse');
const { execFile } = require('child_process');
let parser = new ArgumentParser({});

parser.addArgument('-xnatID', { required: true});
parser.addArgument('-host', { required: true });
parser.addArgument('-user', { required: true });
parser.addArgument('-pwd', { required: true });

const { xnatID, host, user, pwd } = parser.parseArgs();
const XnatDataClient = '/data/xnat/pipeline/xnat-tools/XnatDataClient'
const args = ['-u', user, '-p', pwd, '-r', `${host}/REST/experiments/${xnatID}/scans/psg?format=json`];

const { SSE_URL, SSE_KEY_G, SSE_KENC, TA_URL, SALT_VALUE, IV_VALUE } = process.env;

if (!(SSE_URL && SSE_KEY_G && SSE_KENC && TA_URL && SALT_VALUE && IV_VALUE)) {
    throw 'One or more of the following environment variables are on set: ' +
        'SSE_URL, SSE_KEY_G, SSE_KENC, TA_URL, SALT_VALUE, IV_VALUE';
}

execFile(XnatDataClient, args, function callback(error, stdout, stderr) {
    if (error) {
        console.error(stderr);
        throw error;
    }
    const session = JSON.parse(stdout);
    const data = session.items[0].data_fields;

    uploadData(data, data.image_session_ID, SSE_KEY_G, SSE_KENC);
});